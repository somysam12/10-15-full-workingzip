<?php
// --- UNIVERSAL AJAX ERROR HANDLER ---
// This block will catch ANY error and ensure a JSON response is sent for AJAX requests.
function custom_error_handler($level, $message, $file, $line) {
    if (error_reporting() & $level) {
        throw new ErrorException($message, 0, $level, $file, $line);
    }
}
set_error_handler('custom_error_handler');

function fatal_shutdown_handler() {
    $last_error = error_get_last();
    if ($last_error && in_array($last_error['type'], [E_ERROR, E_CORE_ERROR, E_COMPILE_ERROR, E_USER_ERROR, E_PARSE])) {
        // Check if this was an AJAX request
        if (!empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest') {
            if (!headers_sent()) {
                header('Content-Type: application/json; charset=UTF-8', true, 500);
            }
            echo json_encode([
                'success' => false,
                'error' => 'A fatal server error occurred. Check server logs for details.',
                'details' => $last_error['message'] // For debugging
            ]);
        }
    }
}
register_shutdown_function('fatal_shutdown_handler');
// --- END ERROR HANDLER BLOCK ---

require_once 'header.php';

// --- INITIALIZATION ---
$app_id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
if (!$app_id) {
    header("Location: apps.php");
    exit;
}

$error_msg = "";
$success_msg = "";

// --- MAIN LOGIC WRAPPED IN TRY/CATCH ---
try {
    $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

    $app_name_stmt = $pdo->prepare("SELECT app_name FROM apps WHERE id = ?");
    $app_name_stmt->execute([$app_id]);
    $app_name = $app_name_stmt->fetchColumn() ?: "Unknown App";

    // --- UPLOAD HANDLING ---
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        $is_ajax = !empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest';

        if (!isset($_FILES['apk_file']) || $_FILES['apk_file']['error'] !== UPLOAD_ERR_OK) {
            throw new Exception("File upload failed. PHP Error Code: " . ($_FILES['apk_file']['error'] ?? 'Unknown'));
        }

        $upload_dir = 'uploads/apks/';
        if (!is_dir($upload_dir) && !mkdir($upload_dir, 0777, true)) {
            throw new Exception("Failed to create upload directory. Check permissions.");
        }

        $version_name = $_POST['version_name'] ?? 'New Version';
        $file_ext = pathinfo($_FILES['apk_file']['name'], PATHINFO_EXTENSION);
        $clean_name = preg_replace("/[^a-zA-Z0-9_.-]+/", "_", $version_name);
        $file_name = $app_id . "_" . time() . "_" . $clean_name . "." . $file_ext;
        $target_path = $upload_dir . $file_name;

        if (!move_uploaded_file($_FILES['apk_file']['tmp_name'], $target_path)) {
            throw new Exception("Failed to move uploaded file. Check server write permissions for the directory.");
        }
        
        $protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off') ? "https" : "http";
        $host = $_SERVER['HTTP_HOST'];
        $script_dir = dirname($_SERVER['PHP_SELF']);
        $apk_url = rtrim($protocol . "://" . $host . $script_dir, '/') . '/' . $target_path;

        $pdo->beginTransaction();
        $pdo->prepare("UPDATE app_versions SET is_latest = 0 WHERE app_id = ?")->execute([$app_id]);
        $pdo->prepare("INSERT INTO app_versions (app_id, version_name, apk_url, is_latest, version_code, created_at) VALUES (?, ?, ?, 1, ?, NOW())")
            ->execute([$app_id, $version_name, $apk_url, time()]);
        $pdo->commit();

        if ($is_ajax) {
            header('Content-Type: application/json');
            echo json_encode(['success' => true]);
            exit;
        }
        header("Location: app_details.php?id=$app_id&msg=uploaded");
        exit;
    }

} catch (Exception $e) {
    if (isset($pdo) && $pdo->inTransaction()) {
        $pdo->rollBack();
    }
    error_log("Caught Exception: " . $e->getMessage()); // Log error for debugging
    $error_msg = $e->getMessage();

    $is_ajax_check = !empty($_SERVER['HTTP_X_REQUESTED_WITH']) && strtolower($_SERVER['HTTP_X_REQUESTED_WITH']) == 'xmlhttprequest';
    if ($is_ajax_check) {
        if (!headers_sent()) {
             header('Content-Type: application/json; charset=UTF-8', true, 500);
        }
        echo json_encode(['success' => false, 'error' => $error_msg]);
        exit;
    }
}

// --- DATA FETCHING FOR DISPLAY ---
$history_stmt = $pdo->prepare("SELECT id, version_name, apk_url, is_latest, created_at FROM app_versions WHERE app_id = ? ORDER BY id DESC");
$history_stmt->execute([$app_id]);
$history_items = $history_stmt->fetchAll();

if (isset($_GET['msg']) && $_GET['msg'] === 'uploaded') {
    $success_msg = "APK uploaded successfully and is now LIVE!";
}
?>

<!-- HTML & DISPLAY (No changes needed here from previous version, but included for completeness) -->
<div class="container-fluid py-4">
    <div class="d-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 text-white">Manage: <?php echo htmlspecialchars($app_name ?? 'App'); ?></h1>
        <a href="apps.php" class="btn btn-outline-light btn-sm">Back to Apps</a>
    </div>

    <div id="alert-container">
        <?php if ($error_msg): ?>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <strong>Error:</strong> <?php echo htmlspecialchars($error_msg); ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <?php endif; ?>
        <?php if ($success_msg): ?>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <?php echo htmlspecialchars($success_msg); ?>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        <?php endif; ?>
    </div>

    <div class="row">
        <!-- Upload Form Column -->
        <div class="col-md-5">
            <div class="card bg-dark border-secondary shadow mb-4">
                <div class="card-header bg-dark border-secondary text-primary font-weight-bold">New APK Upload</div>
                <div class="card-body">
                    <form id="uploadForm" method="POST" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="version_name" class="text-white-50 small">Display Name</label>
                            <input type="text" id="version_name" name="version_name" class="form-control bg-dark text-white border-secondary" placeholder="e.g. App v2.5 (Hotfix)" required>
                        </div>
                        <div class="mb-3">
                            <label for="apkFileInput" class="text-white-50 small">Select APK File</label>
                            <input type="file" name="apk_file" id="apkFileInput" class="form-control bg-dark text-white border-secondary" accept=".apk" required>
                        </div>
                        <div id="uploadProgressContainer" class="mb-3 d-none">
                            <div class="progress bg-dark-subtle border border-secondary" style="height: 25px;">
                                <div id="uploadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary fw-bold" role="progressbar" style="width: 0%;" aria-valuenow="0">0%</div>
                            </div>
                        </div>
                        <button type="submit" id="uploadBtn" class="btn btn-primary w-100">
                            <i class="fas fa-upload me-2"></i>Upload & Activate
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- History Column -->
        <div class="col-md-7">
            <div class="card bg-dark border-secondary shadow">
                <div class="card-header bg-dark border-secondary text-primary font-weight-bold">
                    Uploaded Files History (<?php echo count($history_items); ?>)
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead class="small text-uppercase text-white-50">
                                <tr>
                                    <th class="border-secondary px-4">Version Details</th>
                                    <th class="border-secondary">Status</th>
                                    <th class="border-secondary px-4 text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php if (empty($history_items)): ?>
                                    <tr><td colspan="3" class="text-center py-5 text-white-50">No uploads found for this app.</td></tr>
                                <?php else: ?>
                                    <?php foreach ($history_items as $v): ?>
                                        <tr>
                                            <td class="px-4 align-middle">
                                                <div class="text-white fw-bold"><?php echo htmlspecialchars($v['version_name']); ?></div>
                                                <small class="text-white-50"><?php echo date('M d, Y, h:i A', strtotime($v['created_at'])); ?></small>
                                            </td>
                                            <td class="align-middle">
                                                <?php if ($v['is_latest']): ?>
                                                    <span class="badge bg-success fs-6">LIVE</span>
                                                <?php else: ?>
                                                    <span class="badge bg-secondary opacity-50">OLD</span>
                                                <?php endif; ?>
                                            </td>
                                            <td class="px-4 text-end align-middle">
                                                <a href="<?php echo htmlspecialchars($v['apk_url']); ?>" target="_blank" class="btn btn-sm btn-outline-info">
                                                   <i class="fas fa-download me-1"></i> Download
                                                </a>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const progressContainer = document.getElementById('uploadProgressContainer');
    const progressBar = document.getElementById('uploadProgressBar');
    const alertContainer = document.getElementById('alert-container');

    uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        alertContainer.innerHTML = '';
        
        const formData = new FormData(uploadForm);
        const originalButtonHtml = uploadBtn.innerHTML;

        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Uploading...';
        progressContainer.classList.remove('d-none');
        
        // Simulate progress for fetch (since it doesn't support it directly)
        // A real progress bar would need XMLHttpRequest, but this is a UI improvement.
        progressBar.style.width = '50%';
        progressBar.textContent = '50%';


        try {
            const response = await fetch(window.location.href, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                body: formData,
            });

            progressBar.style.width = '100%';
            progressBar.textContent = '100%';

            const result = await response.json();

            if (!response.ok || result.success === false) {
                throw new Error(result.error || 'An unknown server error occurred.');
            }

            // Success: redirect to show the updated list and success message
            window.location.href = `app_details.php?id=<?php echo $app_id; ?>&msg=uploaded&v=${new Date().getTime()}`;

        } catch (error) {
            // Failure: show an error message in the alert container
            const errorHtml = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Upload Failed:</strong> ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
            alertContainer.innerHTML = errorHtml;
        } finally {
            // Always re-enable button and hide progress bar
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalButtonHtml;
            setTimeout(() => { // Hide progress bar after a short delay
                 progressContainer.classList.add('d-none');
                 progressBar.style.width = '0%';
                 progressBar.textContent = '0%';
            }, 1000);
        }
    });
});
</script>

<?php require_once 'footer.php'; ?>